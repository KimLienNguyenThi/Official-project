@{
    ViewBag.Title = "Phiếu Mượn";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}
<div class="mt-2">
    <h1 class="text-center text-blue text-bold">PHIẾU MƯỢN</h1>
</div>
<div class="row ml-2 d-flex justify-content-between align-items-center">
    <!-- Ô tìm kiếm bên trái -->
    <div class="col-4 d-flex align-items-center" id="SearchPM">
        <input type="text" id="searchInput" class="form-control mb-2" placeholder="Search">
        <button type="submit" class="btn btn-default ml-2 mb-2" id="searchButton">
            <i class="fas fa-search"></i>
        </button>
    </div>
</div>

    <div class="card-body table-responsive p-0">
        <form>
            <!--Danh sách sách mượn-->
            <div class="text-center" id="tableThongTinDocGia">
                <table class="table table-hover table-head-fixed table-bordered">
                    <thead>
                        <tr>
                            <th>Mã Thẻ</th>
                            <th>Họ tên</th>
                            <th>Giới tính</th>
                            <th>Ngày sinh</th>
                            <th>SDT</th>
                            <th>Địa chỉ</th>
                            <th>Hạn thẻ</th>
                            <th>Lập phiếu mượn</th>
                        </tr>
                    </thead>
                    <tbody id="ListThongTinĐocGia">
                    @foreach (var item in ViewData["ThongTinDocGia"] as List<WebApp.Areas.Admin.Data.DTO_DocGia_TheDocGia>)
                        {
                            var ngayHetHan = item.NgayHetHan.HasValue ? item.NgayHetHan.Value.ToDateTime(new TimeOnly()) : DateTime.MinValue;
                            var tinhTrangThe = ngayHetHan < DateTime.Now ? "Hết hạn" : "Còn hạn";
                        <tr class="thongtindocgia-row" data-ma-the="@item.MaThe">
                            <td>@item.MaThe</td>
                            <td>@item.HoTenDG</td>
                            <td>@item.GioiTinh</td>
                            <td>@string.Format("{0:MM-dd-yyyy}", item.NgaySinh)</td>
                            <td>@item.SDT</td>
                            <td>@item.DiaChi</td>
                            <td>
                               
                                <span class="badge badge-@(tinhTrangThe == "Hết hạn" ? "danger" : "success")">
                                    @tinhTrangThe
                                </span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-primary" onclick="lapPhieuMuon('@item.MaThe')" 
                                @((ngayHetHan < DateTime.Now) ? "disabled" : "")>
                                    Lập phiếu mượn
                                </button>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </form>
    </div>

<!-- Modal lập phiếu mượn -->
<div class="modal fade bd-example-modal-lg" id="ModalPhieuMuon" tabindex="-1" role="dialog" aria-labelledby="exampleModalScrollableTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog modal-lg" role="document">
        <div class="modal-content">

            <!-- Header -->
            <div class="modal-header text-center">
                <h4 class="modal-title w-100 text-blue" style="font-weight: bold;" id="">Phiếu mượn</h4>
            </div>

            <!-- Body -->
            <form class="modal-body p-4">
                <div class="form-row">
                    <!--Mã PM-->
                    <div class="form-group col">
                        <label for="name">Mã ĐK:</label>
                        <input type="text" class="form-control" id="MaDK" name="MaDK" readonly>
                    </div>
                    <div class="form-group col">
                        <label for="name">Mã thẻ độc giả:</label>
                        <input type="text" class="form-control" id="MaThe" name="MaThe" readonly>
                    </div>
                    <div class="form-group col">
                        <label for="MaNhanVien">Mã nhân viên:</label>
                        <input type="text" class="form-control" id="MaNhanVien" name="MaNhanVien" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <!--Tên độc giả-->
                    <div class="form-group col">
                        <label for="Name">Tên độc giả:</label>
                        <input type="text" class="form-control" id="Name" name="Name" readonly>
                    </div>

                    <!--số điện thoại-->
                    <div class="form-group col">
                        <label for="Name">Số điện thoại:</label>
                        <input type="text" class="form-control" id="SDT" name="SDT" readonly>
                    </div>

                </div>

                <div class="form-row">
                    <!--Ngày mượn-->
                    <div class="form-group col">
                        <label for="NgayMuon">Ngày mượn:</label>
                        <input type="date" class="form-control" id="NgayMuon" name="NgayMuon" readonly>
                    </div>
                    <!--Hạn trả-->
                    <div class="form-group col">
                        <label for="HanTra">Hạn trả:</label>
                        <select class="form-control" id="HanTra" name="HanTra">
                            <option>-- Chọn hạn trả --</option>
                            <option value="1">1 tuần</option>
                            <option value="2">2 tuần</option>
                            <option value="3">3 tuần</option>
                            <option value="4">4 tuần</option>
                        </select>
                    </div>
                </div>

                <!-- Phần thêm nút và ô tìm kiếm -->
                <div class="d-flex justify-content-end mb-3">
                    <!-- Ô tìm kiếm -->
                    <div class="input-group" style="width: 300px;">
                        <input type="text"
                               id="searchSach"
                               class="form-control"
                               placeholder="Tìm kiếm sách..." >
                              @*  onclick="themSach()"> *@
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                    </div>

                    <!-- Nút thêm -->
                    <button type="button" class="btn btn-success ml-2" onclick="themSach()">Thêm +</button>
                </div>

                <!--Danh sách sách mượn-->
                <div class="text-center">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Mã sách</th>
                                <th>Mã cuốn sách</th>
                                <th>Tên sách</th>
                                <th>Số lượng</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="danhSachSachTra">
                            <!-- Dữ liệu sẽ được load động -->
                        </tbody>
                    </table>
                </div>
            </form>

            <!-- Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary taohoadonbymapt">Tạo</button>
            </div>
        </div>
    </div>
</div>



@section scripts
{
    <script>



        //=====================  Lập phiếu mượn  =====================
        function lapPhieuMuon(maThe) {
            // Gọi API kiểm tra thông tin phiếu mượn với mã thẻ
            $.ajax({
                url: '@Url.Action("ValidatePhieuMuon", "phieumuon")',
                type: 'POST',
                data: { maThe: maThe },
                success: function (response) {
                    if (response.success) {
                        openModal(maThe);  // Mở modal khi thành công
                    } else {
                        alert(response.message);  // Hiển thị thông báo lỗi khi không thành công
                    }
                },
                error: function () {
                    alert("Đã xảy ra lỗi khi kiểm tra phiếu mượn.");
                }
            });
        }


        function openModal(maThe) {
            // Lấy hàng thông tin độc giả dựa trên `data-ma-the`
            const row = document.querySelector(`tr[data-ma-the="${maThe}"]`);
            if (!row) {
                alert('Không tìm thấy thông tin cho mã thẻ: ' + maThe);
                return;
            }

            // Lấy dữ liệu từ các cột của hàng
            const data = {
                MaThe: maThe, // Mã thẻ
                Name: row.children[1]?.innerText.trim() || "", // Họ tên
                SDT: row.children[4]?.innerText.trim() || "", // Số điện thoại
                NgayMuon: new Date().toISOString().split('T')[0] // Ngày mượn (hôm nay)
            };

            // Kiểm tra giá trị của dữ liệu lấy được
            console.log("Dữ liệu truyền vào modal:", data);

            // Gán giá trị vào các phần tử modal
            Object.keys(data).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = data[id];
                } else {
                    console.error(`Không tìm thấy phần tử với id "${id}"`);
                }
            });
            // Reset danh sách sách mượn về trạng thái trống
            const danhSachSachTra = document.getElementById("danhSachSachTra");
            danhSachSachTra.innerHTML = ""; // Xóa toàn bộ nội dung trong bảng
            // Hiển thị modal
            $('#ModalPhieuMuon').modal('show');
        }



        //khong cho nhap chu
        function validateInput(event, maxQuantity) {
            // Prevent input of non-numeric characters
            if (!isNumericInput(event)) {
                event.preventDefault();
            }
            // Prevent input of 'e' or 'E'
            if (event.key === 'e' || event.key === 'E') {
                event.preventDefault();
            }
            // Ensure the input is within the allowed range (0 to maxQuantity)
            let inputValue = event.target.value;
            if (inputValue < 0 || inputValue > maxQuantity) {
                event.preventDefault();
            }
        }
        function isNumericInput(event) {
            const key = event.key;
            return (key >= '0' && key <= '9') || key === 'Backspace' || key === 'Delete' || key === 'ArrowLeft' || key === 'ArrowRight';
        }

        function searchDocGia() {
            // Lấy giá trị từ ô input
            var keyword = document.getElementById("inputSearch").value.toLowerCase();

            // Lấy danh sách các hàng trong bảng thongTinDocGiaTable
            var docGiaRows = document.querySelectorAll("#thongTinDocGiaTable tbody tr");

            // Duyệt qua từng hàng để kiểm tra từ khóa
            docGiaRows.forEach(function (row) {
                // Lấy nội dung của từng ô trong hàng
                var maThe = row.querySelector("td:nth-child(1)").textContent.toLowerCase();
                var hoTen = row.querySelector("td:nth-child(2)").textContent.toLowerCase();
                var sdt = row.querySelector("td:nth-child(3)").textContent.toLowerCase();
                var diaChi = row.querySelector("td:nth-child(4)").textContent.toLowerCase();

                // Kiểm tra xem từ khóa có xuất hiện trong bất kỳ ô nào hay không
                if (maThe.includes(keyword) || hoTen.includes(keyword) || sdt.includes(keyword) || diaChi.includes(keyword)) {
                    // Hiển thị hàng nếu có từ khóa
                    row.style.display = "table-row";
                } else {
                    // Ẩn hàng nếu không có từ khóa
                    row.style.display = "none";
                }
            });
        }

        function searchSach() {
            // Lấy giá trị nhập từ ô tìm kiếm
            var searchTerm = document.getElementById("inputSearch").value.toLowerCase();

            // Lặp qua từng hàng sách trong bảng sách
            var sachRows = document.querySelectorAll("#thongTinSachTable tbody tr.sach-row");
            sachRows.forEach(function (row) {
                var maSach = row.querySelector("td:first-child").innerText.toLowerCase();
                var tenSach = row.querySelector("td:nth-child(2)").innerText.toLowerCase();

                // Kiểm tra xem từ khóa tìm kiếm có xuất hiện trong thông tin sách không
                if (maSach.includes(searchTerm) || tenSach.includes(searchTerm)) {
                    // Nếu có, hiển thị hàng sách
                    row.style.display = "table-row";
                } else {
                    // Nếu không, ẩn hàng sách
                    row.style.display = "none";
                }
            });


        }
        function search() {
            if (thongTinDocGiaTable.style.display = "block" && thongTinSachTable.style.display == "none") {
                searchDocGia();
            }
            else {
                searchSach();
            }
        }
        function handleKeyPress(event) {
            // Kiểm tra xem người dùng đã nhấn phím "Enter" chưa (mã ASCII: 13)
            if (event.keyCode === 13) {
                // Ngăn chặn hành động mặc định của phím "Enter" trên form
                event.preventDefault();
            }
            // Gọi hàm tìm kiếm khi người dùng nhấn "Enter"
            if (thongTinDocGiaTable.style.display = "block" && thongTinSachTable.style.display == "none") {
                searchDocGia();
            }
            else {
                searchSach();
            }

        }

       
        //=====================  Set dữ liệu mặc định  =====================

        // Lấy ngày hiện tại
        var currentDate = new Date();

        // Định dạng ngày hiện tại thành chuỗi YYYY-MM-DD
        var formatCurrentDate = currentDate.toISOString().slice(0, 10);

        // Set ngày mượn là ngày hiện tại
        document.getElementById("NgayMuon").value = formatCurrentDate;

        // Set mã nhân viên
        var manv = @User.FindFirst("MaNV")?.Value;   // Update MaNV
        document.getElementById("MaNhanVien").value = manv;

        function changeTableShow(tableToShow, tableToHide, tableToHide2) {
            tableToShow.style.display = "block";
            tableToHide.style.display = "none";
            tableToHide2.style.display = "none";
        }



        // Lấy các phần tử của bảng
        var thongTinDocGiaTable = document.getElementById("thongTinDocGiaTable");
        var thongTinSachTable = document.getElementById("thongTinSachTable");
        var thongTinDKONLTable = document.getElementById("thongTinDKONLTable");
        // Mặc định chọn nút "Thông tin độc giả"
        changeTableShow(thongTinDocGiaTable, thongTinSachTable, thongTinDKONLTable);



        //=====================  Lấy dữ liệu khi click vào hàng trong table thông tin độc giả  =====================
        var docGiaRows = document.querySelectorAll(".docgia-row");

        // Xử lý sự kiện nhấp cho từng hàng
        docGiaRows.forEach(function (row) {
            row.addEventListener("click", function () {
                var maDK = parseInt(document.getElementById("MaDK").value);
                if (maDK != 0) {
                    lamMoiPhieuMuonV2();
                }

                document.getElementById("MaDK").value = "0";
                // Lấy thông tin tên từ cột Họ tên của hàng
                var maThe = row.querySelector("td:nth-child(1)").textContent;
                var hoTen = row.querySelector("td:nth-child(2)").textContent;
                var sdt = row.querySelector("td:nth-child(3)").textContent;

                // Hiển thị thông tin tên vào input tên độc giả trong form
                document.getElementById("MaThe").value = maThe;
                document.getElementById("Name").value = hoTen;
                document.getElementById("SDT").value = sdt;
            });
        });

        //=====================  Xử lý tìm và thêm sách =====================
       




        //=====================  Xử lý click vào hàng trong table Thông Tin Sách  =====================
        var sachRows = document.querySelectorAll(".sach-row");

        // Xử lý sự kiện nhấp cho từng hàng
        sachRows.forEach(function (row) {
            row.addEventListener("click", function () {

                // set la
                document.getElementById("inputSoluong").value = '';

                // Ẩn tất cả các hàng chi tiết sách trước
                var bookDetailsRows = document.querySelectorAll(".sach-details");

                bookDetailsRows.forEach(function (detailsRow) {
                    detailsRow.style.display = "none";
                });

                // Hiển thị hàng chi tiết sách tương ứng nếu nó tồn tại
                var bookDetailsRow = row.querySelector(".sach-details");
                if (bookDetailsRow) {
                    bookDetailsRow.style.display = "table-row";
                }
            });
        });



        ////=====================  Xử lý sự kiện khi click vào 1 hàng  trong table đăng ký mượn sách  =====================
        var thongTinDKONLTable = document.getElementById("thongTinDKONLTable");
        thongTinDKONLTable.addEventListener("click", function (event) {
            var targetRow = event.target.closest(".dkOnl-row");
            if (targetRow) {
                // Lấy thông tin tên từ cột Họ tên của hàng
                var maDk = targetRow.querySelector("td:nth-child(1)").textContent;
                var maThe = targetRow.querySelector("td:nth-child(2)").textContent;
                var sdt = targetRow.querySelector("td:nth-child(3)").textContent;
                var hoTen = targetRow.querySelector("td:nth-child(4)").textContent;

                // Hiển thị thông tin tên vào input tên độc giả trong form
                document.getElementById("MaThe").value = maThe;
                document.getElementById("MaDK").value = maDk;
                document.getElementById("Name").value = hoTen;
                document.getElementById("SDT").value = sdt;


                var maDK = parseInt(document.getElementById("MaDK").value);
                // Lấy số lượng hiện tại của sách
                var soLuongHienTai = parseInt($(this).closest("tr").prev().find("td:nth-child(3)").text());


                // Gửi yêu cầu POST để thêm sách mượn
                $.ajax({
                    url: '@Url.Action("ThemSachMuon", "PhieuMuon")',
                    type: 'POST',
                    data: {
                        MaSach: 0,
                        TenSach: '',
                        SoLuong: 0,
                        MaDK: maDK
                    },
                    success: function (res) {
                        if (res.success) {

                            // Cập nhật danh sách sách mượn trong view
                            var danhSachSachMuon = $("#danhSachSachMuon");

                            // Xóa nội dung bảng
                            danhSachSachMuon.empty();

                            $.each(res.data, function (index, item) {
                                var newRow = $(` <tr class="sachmuon-row" data-ma-sach="${item.maSach}">
                                                                    <td>${item.maSach}</td>
                                                                    <td>${item.tenSach}</td>
                                                                    <td>${item.soLuong}</td>
                                                                    <td>
                                                                    <button type="button" class="btn btn-danger xoaSachMuon">Xóa</button>
                                                                    </td>
                                                          </tr> `);

                                danhSachSachMuon.append(newRow);
                            });

                            // Gọi hàm suKienXoaSach để cập nhật sự kiện xóa cho các hàng sách mượn
                            suKienXoaSach();

                            // Cập nhật lại số lượng hiện tại của sách
                            var soLuongMoi = soLuongHienTai - soLuongMuon;
                            console.log("So luong hien tai: ", soLuongHienTai);
                            trPhiaTren.find("td:nth-child(3)").text(soLuongMoi);
                        }
                    }
                });
            }
        });

      


        //=====================  Button Thêm sách  =====================
        var themSachButton = document.querySelectorAll(".themSachButton");

        //Xử lý sự kiện nhấp cho từng hàng
        themSachButton.forEach(function (button) {
            button.addEventListener("click", function () {
                // test sự kiện
                console.log("Gọi hàm thêm sách");

                var trPhiaTren = $(this).closest("tr").prev();
                if (trPhiaTren.length > 0) {

                    var maSach = trPhiaTren.find("td:nth-child(1)").text();
                    var tenSach = trPhiaTren.find("td:nth-child(2)").text();
                    var maDK = parseInt(document.getElementById("MaDK").value);
                    // Lấy số lượng hiện tại của sách
                    var soLuongHienTai = parseInt($(this).closest("tr").prev().find("td:nth-child(3)").text());

                    var soLuongMuon = this.parentElement.previousElementSibling.querySelector("#inputSoluong").value;

                    console.log("soLuongHienTai: ", soLuongHienTai);
                    console.log("Số lượng mượn: ", soLuongMuon);


                    if (!Number.isInteger(Number(soLuongMuon)) || soLuongMuon > soLuongHienTai || soLuongMuon <= 0 || soLuongMuon > 2) {
                        document.getElementById("contentModalError").innerHTML = "Hãy nhập đúng số lượng sách mượn!";
                        $("#ModalError").modal("show");
                    } else {
                        console.log("Bắt đầu gọi Ajax");

                        // Gửi yêu cầu POST để thêm sách mượn
                        $.ajax({
                            url: '@Url.Action("ThemSachMuon", "PhieuMuon")',
                            type: 'POST',
                            data: {
                                MaSach: maSach,
                                TenSach: tenSach,
                                SoLuong: soLuongMuon,
                                MaDK: maDK
                            },
                            success: function (data) {
                                if (data.success) {

                                    // Cập nhật danh sách sách mượn trong view
                                    var danhSachSachMuon = $("#danhSachSachMuon");

                                    // Xóa nội dung bảng
                                    danhSachSachMuon.empty();

                                    $.each(data.data, function (index, item) {
                                        console.log(item);

                                        var newRow = $(` <tr class="sachmuon-row" data-ma-sach="${item.maSach}">
                                                                            <td>${item.maSach}</td>
                                                                            <td>${item.tenSach}</td>
                                                                            <td>${item.soLuong}</td>
                                                                            <td>
                                                                            <button type="button" class="btn btn-danger xoaSachMuon">Xóa</button>
                                                                            </td>
                                                                        </tr> `);

                                        danhSachSachMuon.append(newRow);
                                    });

                                    // Gọi hàm suKienXoaSach để cập nhật sự kiện xóa cho các hàng sách mượn
                                    suKienXoaSach();

                                    // Cập nhật lại số lượng hiện tại của sách
                                    var soLuongMoi = soLuongHienTai - soLuongMuon;
                                    trPhiaTren.find("td:nth-child(3)").text(soLuongMoi);
                                } 
                                else {
                                    document.getElementById("contentModalError").innerHTML = data.message;
                                    $("#ModalError").modal("show");
                                }
                            }
                        });
                    }
                } else {
                    console.log('Không tìm thấy hàng trên');
                }
            });
        });


        //===================== Hàm Làm mới danh sách sách mượn =====================
        function lamMoiPhieuMuon() {
            $.ajax({
                url: '@Url.Action("LamMoiDanhSachSachMuon", "PhieuMuon")',
                type: 'POST',
                success: function (data) {
                    if (data.success) {
                        // Cập nhật giao diện
                        var danhSachSachMuon = document.getElementById("danhSachSachMuon");
                        danhSachSachMuon.innerHTML = "";

                        document.getElementById("MaThe").value = "";
                        document.getElementById("Name").value = "";
                        document.getElementById("SDT").value = "";
                        document.getElementById("MaDK").value = "0";
                    }
                    document.getElementById("HanTra").value = "-- Chọn hạn trả --";
                }
            });
        }

        function lamMoiPhieuMuonV2() {
            $.ajax({
                url: '@Url.Action("LamMoiDanhSachSachMuon", "PhieuMuon")',
                type: 'POST',
                success: function (data) {
                    if (data.success) {
                        var danhSachSachMuon = $("#danhSachSachMuon");

                        // Xóa nội dung bảng
                        danhSachSachMuon.empty();
                    }
                }
            });
        }

        function lamMoi() {
            lamMoiPhieuMuon();

            // Làm mới trang
            location.reload();
        }


        //=====================  Xử lý khi load lại trang  =====================
        document.addEventListener("DOMContentLoaded", function () {
            lamMoiPhieuMuon();
        });


        //===================== Xử lý Xóa sách mượn =====================
        function suKienXoaSach() {
            // Lấy danh sách các hàng trong bảng


            var danhSachSachMuonRows = document.querySelectorAll(".sachmuon-row");

            // Gán sự kiện click cho nút xóa trên từng hàng
            danhSachSachMuonRows.forEach(function (row) {
                row.querySelector(".xoaSachMuon").addEventListener("click", function () {
                    var maSach = row.querySelector("td:nth-child(1)").textContent;
                    var soLuong = row.querySelector("td:nth-child(3)").textContent;

                    var isDeleting = confirm("Bạn có chắc chắn muốn xóa sách ra khỏi danh sách mượn!");
                    if (isDeleting) {
                        xoaSachMuon(maSach, soLuong);
                    }
                });
            });
        }

        // Hàm xóa 1 sách trong danh sách sách mượn
        function xoaSachMuon(maSach, soLuong) {
            // Gửi yêu cầu AJAX đến controller để xóa sách
            $.ajax({
                url: '@Url.Action("XoaSachMuon", "PhieuMuon")',
                type: 'POST',
                data: { MaSach: maSach },
                success: function (result) {
                    if (result.success) {
                        // Xóa hàng chứa sách đã xóa khỏi bảng
                        var rowToDelete = $(`tr[data-ma-sach="${maSach}"]`);
                        rowToDelete.remove();

                        // Cập nhật lại số lượng hiện tại của sách
                        //var soLuongDaXoa = result.soLuongMuon;

                        // Tìm và cập nhật ô số lượng sách tương ứng
                        var soLuongSach = $(`.soLuongSach[data-ma-sach="${maSach}"]`);
                        var soLuongHienTai = soLuongSach.text();
                        var soLuongMoi = parseInt(soLuongHienTai) + parseInt(soLuong);

                        // Cập nhật lại số lượng hiện tại
                        soLuongSach.text(soLuongMoi);
                    } else {
                        console.log('Xóa sách không thành công');
                    }
                }
            });
        }

        function GetSachDangKy(maDK) {
            $.ajax({
                url: '@Url.Action("GetChiTietDKByMaDK", "DangKyMuonSach")',
                type: 'POST',
                data: {
                    maDK: maDK,
                },
                success: function (data) {
                    if (data.success) {
                        // Xử lý dữ liệu JSON trả về
                        var ctdk = data.data;
                        // Cập nhật danh sách sách mượn trong view
                        var danhSachSachDK = $("#danhSachSachDk");

                        danhSachSachDK.empty(); // Xóa nội dung bảng

                        console.log("ctdk: ", ctdk);

                        $.each(ctdk, function (index, item) {
                            var newRow = $(` <tr class="sachdk-row" data-ma-sach="${item.maSach}">
                                                             <td>${item.maSach}</td>
                                                             <td>${item.tenSach}</td>
                                                             <td>${item.soLuong}</td>
                                                             </tr> `);

                            danhSachSachDK.append(newRow);
                        });
                    } else {
                        console.error("Không thành công trong việc nhận dữ liệu từ server.");
                    }
                }
            });
        }

        //===================== Hàm tạo phiếu mượn =====================
        function taoPhieuMuon() {

            // Lấy tất cả các thẻ tr trong tbody có id là danhSachSachMuon
            var rows = document.querySelectorAll('#danhSachSachMuon tr');

            // Khởi tạo biến tính tổng số lượng sách
            var totalSoLuong = 0;

            // Duyệt qua từng hàng và lấy giá trị của cột SoLuong
            for (var i = 0; i < rows.length; i++) {
                var soLuongCell = rows[i].getElementsByTagName('td')[2]; // Giả sử cột SoLuong là cột thứ 3
                if (soLuongCell) {
                    var soLuong = parseFloat(soLuongCell.textContent || soLuongCell.innerText);
                    if (!isNaN(soLuong)) {
                        totalSoLuong += soLuong;
                    }
                }
            }


            // Kiểm tra xem có thẻ tr nào không
            if (rows.length > 0) {

                if (totalSoLuong > 5) {
                    document.getElementById("contentModalError").innerHTML = "Số lượng sách mượn đang vượt quá 5 quyển!";
                    $("#ModalError").modal("show");
                }
                else {
                    var maTheDocGia = document.getElementById("MaThe").value;
                    var maNhanVien = document.getElementById("MaNhanVien").value;
                    var NgayMuon = document.getElementById("NgayMuon").value;
                    var soNgay = parseInt(document.getElementById("HanTra").value);
                    var maDK = parseInt(document.getElementById("MaDK").value);
                    // Gửi yêu cầu POST để thêm sách mượn
                    if (!maTheDocGia || !maNhanVien || !NgayMuon) {
                        document.getElementById("contentModalError").innerHTML = "Thông tin độc giả không được để trống!";
                        $("#ModalError").modal("show");
                    } else {
                        if (isNaN(soNgay)) {
                            document.getElementById("contentModalError").innerHTML = "Hãy chọn hạn trả!";
                            $("#ModalError").modal("show");
                        } else {

                            var ngayMuon = new Date(formatCurrentDate); // Tạo đối tượng Date từ chuỗi
                            var ngayTra = new Date(ngayMuon); // Tạo một bản sao của ngayMuon

                            ngayTra.setDate(ngayTra.getDate() + (soNgay * 7));
                            var formatNgayTra = ngayTra.toISOString().slice(0, 10);// Định dạng ngày trả

                            var confirmed = confirm("Bạn có chắc muốn tạo phiếu mượn không?");
                            if (confirmed) {
                                $.ajax({
                                    url: '@Url.Action("TaoPhieuMuon", "PhieuMuon")',
                                    type: 'POST',
                                    data: {
                                        MaNhanVien: maNhanVien,
                                        MaThe: maTheDocGia,
                                        NgayMuon: NgayMuon,
                                        NgayTra: formatNgayTra,
                                        MaDK: maDK
                                    },
                                    success: function (data) {
                                        if (data.success) {

                                            lamMoiPhieuMuon();
                                            GetAllThongTinDangKy();

                                            document.getElementById("contentModalSuccess").innerHTML = "Thêm phiếu mượn thành công!";

                                            $("#ModalSuccess").modal("show");

                                            console.log('Tạo phiếu mượn: ', data);
                                        } else {

                                            document.getElementById("contentModalError").innerHTML = "Hãy thêm sách muốn mượn!";
                                            $("#ModalError").modal("show");
                                            console.log('Tạo phiếu mượn: ', data);
                                        }
                                    }
                                });
                            }
                        }
                    }
                }


            } else {
                document.getElementById("contentModalError").innerHTML = "Hãy thêm sách muốn mượn!";
                $("#ModalError").modal("show");
            }

        }

        function GetAllThongTinDangKy() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetAllThongTinDangKy", "PhieuMuon")',
                success: function (res) {

                    console.log(res.success);

                    if (res.success) {
                        var render = "";


                        $.each(res.result, function (i, item) {

                            console.log("Du lieu tra ve cua ham GetAllThongTinDangKy: ", res.result);

                            var NgayDK = moment(item.ngayDK);
                            var NgayDKFormatted = NgayDK.format('MM/DD/YYYY');

                            var NgayHen = moment(item.ngayHen);
                            var NgayHenFormatted = NgayHen.format('MM/DD/YYYY');

                            render += '<tr class="dkOnl-row" data-ma-thedg=">' + item.maDK + '">';
                            render += '<td>' + item.maDK + '</td>';
                            render += '<td>' + item.maThe + '</td>';
                            render += '<td>' + item.sdt + '</td>';
                            render += '<td>' + item.hoTen + '</td>';
                            render += '<td>' + NgayDKFormatted + '</td>';
                            render += '<td>' + NgayHenFormatted + '</td>';
                            render += '</tr>';
                        });

                        let danhSachThongTinDangKy = document.getElementById("DanhSachThongTinDangKy");
                        danhSachThongTinDangKy.innerHTML = render;
                    }

                },
                error: function (status) {
                    // Hiển thị cảnh báo nếu có lỗi
                    alert("Không tìm thấy dữ liệu");
                }
            });
        }

        async function themSach() {
            const searchInput = document.getElementById("searchSach");
            const maCuonSach = searchInput.value.trim();

            if (!maCuonSach) {
                alert("Vui lòng nhập mã sách!");
                return;
            }

            try {
                // Gửi yêu cầu tìm kiếm sách qua API
                const response = await fetch(`/admin/phieumuon/GetByMaCuonSach/${maCuonSach}`);
                const data = await response.json();

                if (data.success) {
                    if (data.data) {
                        const danhSachSachTra = document.getElementById("danhSachSachTra");

                        // Kiểm tra xem sách đã tồn tại chưa
                        const existingRow = Array.from(danhSachSachTra.children).find(row => {
                            const maCuonSachCell = row.querySelector("td:nth-child(2)");
                            return maCuonSachCell && maCuonSachCell.textContent === maCuonSach;
                        });

                        if (existingRow) {
                            alert("Sách đã được thêm vào danh sách mượn!");
                            return;
                        }

                        // Thêm thông tin sách vào bảng
                        const row = document.createElement("tr");

                        // Mã sách
                        const maSachCell = document.createElement("td");
                        maSachCell.textContent = data.data.maSach;
                        row.appendChild(maSachCell);

                        // Mã cuốn sách
                        const maCuonSachCell = document.createElement("td");
                        maCuonSachCell.textContent = data.data.maCuonSach;
                        row.appendChild(maCuonSachCell);

                        // Tên sách
                        const tenSachCell = document.createElement("td");
                        tenSachCell.textContent = data.data.tenSach;
                        row.appendChild(tenSachCell);

                        // Số lượng (mặc định là 1)
                        const soLuongCell = document.createElement("td");
                        soLuongCell.textContent = "1";
                        row.appendChild(soLuongCell);

                        // Thao tác (nút xóa)
                        const thaoTacCell = document.createElement("td");
                        const deleteButton = document.createElement("button");
                        deleteButton.textContent = "Xóa";
                        deleteButton.classList.add("btn", "btn-danger", "btn-sm");
                        deleteButton.addEventListener("click", function () {
                            xoaSach(this);
                        });
                        thaoTacCell.appendChild(deleteButton);
                        row.appendChild(thaoTacCell);

                        danhSachSachTra.appendChild(row);

                        // Xóa giá trị trong ô tìm kiếm
                        searchInput.value = "";
                    } else {
                        alert("Mã cuốn sách không tồn tại. Vui lòng kiểm tra lại.");
                    }
                } else {
                    alert(data.message || "Lỗi tìm kiếm sách.");
                }
            } catch (error) {
                console.error("Error fetching books:", error);
                alert("Đã xảy ra lỗi khi tìm kiếm sách!");
            }
        }

        // Hàm xóa sách
        function xoaSach(button) {
            if (confirm("Bạn có chắc muốn xóa sách này?")) {
                const row = button.parentElement.parentElement;
                row.remove();
            }
        }


        // function themSach(maSach, maCuonSach, tenSach) {
        //     const tableBody = document.getElementById("danhSachSachTra");

        //     // Kiểm tra xem sách đã có trong bảng chưa
        //     const existingRows = tableBody.getElementsByTagName("tr");
        //     for (let row of existingRows) {
        //         const codeCell = row.cells[0].textContent.trim();
        //         if (codeCell === maCuonSach) {
        //             alert("Sách này đã được thêm vào bảng.");
        //             return;
        //         }
        //     }

        //     // Thêm sách vào bảng nếu chưa có
        //     const row = document.createElement("tr");

        //     row.innerHTML = `
        //         <td>${maSach}</td>
        //         <td>${maCuonSach}</td>
        //         <td>${tenSach}</td>
        // <td><input type="number" value="1" min="1" class="form-control" oninput="capNhatSoLuong(this, '${maCuonSach}')"></td>
        //         <td><button class="btn btn-danger" onclick="xoaSach(this)">Xóa</button></td>
        //     `;

        //     tableBody.appendChild(row);
        // }
        
        function capNhatSoLuong(input, maCuonSach) {
            const quantity = input.value;
            if (quantity <= 0) {
                alert("Số lượng phải lớn hơn 0.");
                input.value = 1; // Đặt lại giá trị mặc định
                return;
            }
            console.log(`Số lượng sách với mã ${maCuonSach} đã được cập nhật thành: ${quantity}`);
        }
    </script>
}